name: Approved - Add Contributor

on:
  issues:
    types: [labeled]

jobs:
  approved-add:
    # ä»…å½“æ‰“ä¸Š approved æ ‡ç­¾ + å­˜åœ¨ add-contributor æ ‡ç­¾ + ç”±æŒ‡å®š Owner æ“ä½œæ—¶è¿è¡Œ
    if: |
      github.event.label.name == 'approved' &&
      contains(github.event.issue.labels.*.name, 'add-contributor') &&
      contains(fromJSON('["Rocky77JHxu", "xiaohangguo", "wuming082"]'), github.event.sender.login)

    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Parse issue and create directory
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: python .github/scripts/parse_issue_and_create.py

      - name: Comment and Close (Success)
        if: steps.parse.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `**å®¡æ ¸é€šè¿‡ï¼**\n\nå·²ä¸ºä½ åˆ›å»ºç›®å½•ï¼š\n\n\`${{ steps.parse.outputs.domain }}/${{ steps.parse.outputs.username }}/\`\n\næ¬¢è¿åŠ å…¥é¡¹ç›®ï¼ğŸ‰`
            });
            await github.rest.issues.update({
              owner, repo, issue_number,
              state: 'closed',
              state_reason: 'completed'
            });

      - name: Comment and Close (Failure)
        if: steps.parse.outputs.success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `**å®¡æ ¸é€šè¿‡ï¼Œä½†æ ¼å¼é”™è¯¯ï¼**\n\næ— æ³•è§£æä½ çš„è¯·æ±‚ã€‚è¯·ç¡®ä¿æ­£æ–‡åŒ…å«ï¼š\n\`\`\`\näººå·¥æ™ºèƒ½: WangZipeng\n\`\`\`\n\nè¯·è”ç³»ç®¡ç†å‘˜ååŠ©ã€‚`
            });
            await github.rest.issues.update({
              owner, repo, issue_number,
              state: 'closed',
              state_reason: 'not_planned'
            });

      - name: Commit and push (on success)
        if: steps.parse.outputs.success == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "Add ${{ steps.parse.outputs.username }} to ${{ steps.parse.outputs.domain }} (Approved via Issue #${{ github.event.issue.number }})"
          git push